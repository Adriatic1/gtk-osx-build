# -*- mode: python -*-
#
# Copyright (C) 2006, 2007, 2008 Imendio AB
#
# Default setup for building GTK+ on Mac OS X. Note that you should
# normally never need to edit this file. Any custom settings should be
# done in ~/.jhbuildrc-custom.
#
# Specific builds can be set up by creating files named
# ~/.jhbuildrc-<build>. When setting the environment variable JHB to
# such a name, the corresponding rc file will be read (e.g.:
# JHB=mybuild jhbuild shell).
#
# Use .jhbuildrc-custom to override the moduleset, modules to build,
# the source checkout location, installation prefix, or svn usernames
# etc.
#
# Please email richard@imendio.com if you have suggestions for
# improving this setup, or have any patches that you would like to get
# included.

import sys
import errno

# Some utitily functions used here and in custom files:
#
def environ_append(key, value, separator=' '):
    old_value = os.environ.get(key)
    if old_value is not None:
        value = old_value + separator + value
    else:
        os.environ[key] = value

def environ_prepend(key, value, separator=' '):
    old_value = os.environ.get(key)
    if old_value is not None:
        value = value + separator + old_value
    os.environ[key] = value

def parse_custom_argument(key):
    for i, arg in enumerate(sys.argv):
        if arg == key and i+1 < len(sys.argv):
            return sys.argv[i+1]
    return None

def autogenargs_for_arch(root, arch, original_cflags, original_cxxflags, original_ldflags):
    # Possibly also need '-Wl,-syslibroot,' + root for ldflags...
    return \
        'CFLAGS="' + original_cflags + ' -isysroot ' + root + ' -arch ' + arch + '" ' + \
        'CXXFLAGS="' + original_cxxflags + ' -isysroot ' + root + ' -arch ' + arch + '" ' + \
        'LDFLAGS="' + original_ldflags + ' -arch ' + arch + '"'


# Moduleset to use.
#
moduleset = 'http://developer.imendio.com/svn/gtk-osx-build/gtk-osx.modules'

# A list of the modules to build.
#
modules = [ 'meta-gtk-osx-bootstrap', 'meta-gtk-osx-core' ]

# A list of modules to skip.
#
skip = [ 'python', 'gmp', 'guile' ]

# The directory where the source will be checked out to.
#
checkoutroot = os.path.expanduser('~/Source/gnome')

# The prefix to configure/install modules to (must have write access).
#
prefix = '/opt/gtk'

# Extra arguments to pass to all autogen.sh scripts.
#
autogenargs='--disable-static --disable-gtk-doc --disable-docs --disable-scrollkeeper'
alwaysautogen = True

# Set debugging format to the old one from Tiger and earlier since the new
# default in Leopard breaks many things. Also set gnu89 as the new default
# gnu99 changes how extern inline works, breaking, glib's inline setup,
# until glib is fixed.
#
os.environ['CFLAGS'] = '-O -gstabs+3 -std=gnu89'
os.environ['CXXFLAGS'] = '-O -gstabs+3'

# Use the included install-check program if available. It won't update
# timestamps if the header hasn't changed, which speeds up builds.
#
path = os.path.expanduser('~/bin/install-check')
if os.path.exists(path):
    os.environ['INSTALL'] = path

# When building on intel, force build to be 486, since glib won't
# enable asm atomic operations otherwise.
#
try:
    f = os.popen('uname -p')
    if f.read().startswith('i386'):
        module_autogenargs['glib'] = autogenargs + ' --build=i486-apple-darwin'
except:
    pass

# Prefix to use in the shell, can be overridden in the custom rc file
# or in specific setups. Can be set to None to be removed.
prompt_prefix = "JH"

default_build = ""

# Import optional user RC for further customization. You can override
# the prefix or default build setup for example, or CFLAGS or
# module_autogenargs, etc.
#
userrc = os.path.join(os.environ['HOME'], '.jhbuildrc-custom')
if os.path.exists(userrc):
    execfile(userrc)

# Allow including different variants depending on the environment
# variable JHB. This can be used to have different setups for SDK
# builds, for example.
#
build = os.environ.get('JHB', default_build)

# Check and warn if jhbuild is started from within jhbuild, since that
# will mess up environment variables, especially if different build
# setups are used.
#
old_prefix = os.environ.get('JHBUILD_PREFIX', "")
old_build = os.environ.get('JHBUILD_CONFIG', "")
ran_recursively = old_prefix != ""
if ran_recursively:
    if old_build != build:
        print "Error: jhbuild is already running with a different build setup, exiting."
        raise SystemExit

    print "\n   *** Warning: jhbuild is started from within a jhbuild session ***\n"

if build != "":
    try:
        execfile(os.path.join(os.environ['HOME'], '.jhbuildrc-' + build))
    except EnvironmentError, e:
        print "Couldn't find the file '.jhbuildrc-" + build + "', exiting."
        raise SystemExit

tarballdir = os.path.join(checkoutroot, 'pkgs')

os.environ['PREFIX'] = prefix # Deprecated, please move to JHBUILD_PREFIX.
os.environ['JHBUILD_PREFIX'] = prefix
os.environ['JHBUILD_SOURCE'] = checkoutroot

os.environ['LIBTOOLIZE'] = prefix + '/bin/libtoolize'

# The option "headerpad_max_install_names" is there to leave some room for
# changing the library locations with install_name_tool. Note that GNU
# libtool seems to drop the option if we don't use -W here.
#
environ_append('LDFLAGS', '-Wl,-headerpad_max_install_names')

# Make sure we find our installed modules, and before other versions.
environ_prepend('LDFLAGS', '-L' + prefix + '/lib')
environ_prepend('CPPFLAGS', '-I' + prefix + '/include')

# Add additional Python/Perl paths so that our modules can be found.
#
version = 'python' + str(sys.version_info[0]) + '.' + str(sys.version_info[1])
environ_append('PYTHONPATH', prefix + '/lib/' + version + '/site-packages/gtk-2.0', ':')
environ_append('PERL5LIB', prefix + '/lib/perl5/vendor_perl', ':')
environ_append('PERL5LIB', prefix + '/lib/perl5/site_perl', ':')

# Point gtk-doc and other xlstproc users to our XML catalog.
#
os.environ['XML_CATALOG_FILES'] = prefix + '/etc/xml/catalog'

# Speed up gettext build a lot by disabling unneeded stuff.
#
old_value = module_autogenargs.get('gettext', autogenargs)
module_autogenargs['gettext'] = old_value + ' --without-emacs --disable-java --disable-native-java'

# Support prepending uninstalled frameworks to the PKG_CONFIG_PATH,
# CFLAGS and LDFLAGS variables.  This is used for creating frameworks.
#
frameworks = os.environ.get("JHB_PREPEND_FRAMEWORKS", "")
for framework in frameworks.split(":"):
    if framework != "":
        # Use prependpath from jhbuild here to ensure our paths are
        # added in front of the ones jhbuild sets up.
        prependpath("PKG_CONFIG_PATH", framework + "/Resources/lib/pkgconfig")
        prependpath("PATH", framework + "/Resources/bin")
        environ_prepend("LDFLAGS", "-L" + framework + "/Resources/atlib", " ")
        environ_prepend("CFLAGS", "-I" + framework + "/Headers", " ")

# We do some crude extra argument parsing just to add support for
# getting environment variables. Used in framework creation to pick up
# the jhbuild prefix.
#
value = parse_custom_argument("getenv")
if value:
    print os.environ.get(value, "")
    raise SystemExit

if build:
    print "Build setup: %s, prefix: %s" % (build, prefix)
    os.environ["JHBUILD_CONFIG"] = build
else:
    print "Prefix: %s" % (prefix)

if not ran_recursively and prompt_prefix:
    environ_prepend("PS1", "[" + prompt_prefix + "]", separator=' ')

    # Make it possible to reset this from your .bashrc when dropping
    # into a build error shell, i.e.:
    #
    # if [ "x$JHBUILD_PROMPT" != x ]; then
    #    export PS1=$JHBUILD_PROMPT
    # fi
    os.environ["JHBUILD_PROMPT"] = os.environ.get("PS1", "")

# Unset this se we don't mess with the check for not starting
# recursively.
os.unsetenv("JHB")

if "shell" in sys.argv:
    print "Entered jhbuild shell, type 'exit' to return."
